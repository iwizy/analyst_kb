# UML State Machine

Диаграмма состояний описывает жизненный цикл объекта: допустимые состояния, события перехода и ограничения. Нотация особенно важна там, где статус влияет на доступные действия и интеграционные события.

## Цель и задачи

- формализовать статусную модель объекта;
- убрать противоречия в правилах переходов;
- синхронизировать UI, API и интеграции по одинаковой логике.

## Основные элементы

| Элемент | Назначение |
| --- | --- |
| Initial / Final | Начало и завершение жизненного цикла |
| State | Состояние объекта |
| Transition | Переход между состояниями |
| Trigger | Событие, запускающее переход |
| Guard | Условие допустимости перехода |
| Entry/Exit Action | Действия при входе и выходе |

## Когда применять

- объекты со сложным жизненным циклом (заказ, заявка, инцидент, договор);
- процессы, где нужны строгие ограничения по статусам;
- проверка backward compatibility при добавлении новых статусов.

## Пример

```kroki-plantuml
@startuml
[*] --> Draft
Draft --> PendingPayment : submit
PendingPayment --> Paid : paymentConfirmed
PendingPayment --> Cancelled : paymentTimeout
Paid --> Packed : warehousePacked
Packed --> Shipped : handedToCarrier
Shipped --> Delivered : deliveryConfirmed
Paid --> Refunded : refundApproved [!shipped]
Delivered --> Closed : closeOrder
Cancelled --> [*]
Refunded --> [*]
Closed --> [*]
@enduml
```

## Как построить диаграмму

1. Определите объект и границы его жизненного цикла.
1. Зафиксируйте полный перечень статусов.
1. Для каждого статуса перечислите допустимые события.
1. Добавьте guard-условия для конфликтных переходов.
1. Согласуйте модель со статусами API, UI и хранилища данных.

## Типовые ошибки

- статусы определены, но события переходов не описаны;
- один и тот же переход возможен из разных состояний без явных условий;
- нет терминальных состояний и правил завершения цикла.

## Визуальные рекомендации

- называйте состояния существительными (`PendingPayment`, `Delivered`);
- называйте переходы глаголами-событиями (`paymentConfirmed`, `cancelRequested`);
- избегайте диаграмм длиннее 10-12 состояний, лучше разделять по подсценариям.

## Связь с другими нотациями

- `Sequence`: сообщения из Sequence выступают триггерами переходов.
- `Activity`: ветви Activity должны учитывать доступные состояния объекта.
- `BPMN`: статусы процесса часто зависят от состояния ключевой сущности.

## Инструменты

- [PlantUML](../../tools/plantuml.md)
- [Draw.io](../../tools/drawio.md)
