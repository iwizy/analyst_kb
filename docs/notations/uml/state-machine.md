# [UML](../../glossary.md#abbr-092) State Machine Diagram

[Диаграмма](../../glossary.md#term-022) состояний описывает жизненный цикл сущности и события, которые переводят объект из одного состояния в другое.

## Уровни сложности

### Базовый уровень

- описывать состояния и допустимые переходы;
- фиксировать события переходов;
- различать terminal и промежуточные состояния.

### Средний уровень

- добавлять guard conditions и entry/exit actions;
- моделировать timeout/cancel/retry переходы;
- использовать диаграмму для согласования бизнес-правил.

### Продвинутый уровень

- строить вложенные (composite) состояния;
- использовать state machine для event-driven систем;
- валидировать полноту переходов через тест-дизайн.

## Элементы и синтаксис

| Элемент | Назначение |
| --- | --- |
| State | состояние объекта |
| Transition | переход между состояниями |
| Event | событие, запускающее переход |
| Guard | условие допустимости перехода |
| Entry/Exit action | действия при входе/выходе |
| Final state | терминальное состояние |

## Пример: жизненный цикл заказа

```kroki-plantuml
@startuml
[*] --> Draft
Draft --> Confirmed : confirm()
Confirmed --> Paid : paymentApproved
Confirmed --> Cancelled : cancel()[beforeShipment]
Paid --> Shipped : ship()
Shipped --> Delivered : confirmDelivery
Delivered --> Returned : returnRequested[withinPeriod]
Cancelled --> [*]
Returned --> [*]
Delivered --> [*]
@enduml
```

## Плюсы и минусы

| Плюсы | Минусы |
| --- | --- |
| выявляет недопустимые переходы заранее | не показывает полную архитектуру процесса |
| хорошо подходит для статусов сущности | при большом числе состояний диаграмма усложняется |
| помогает [QA](../../glossary.md#abbr-067) строить тест-кейсы переходов | требует строгой дисциплины именования |

## Когда выбирать

- у объекта есть жизненный цикл со статусами;
- требуется формализовать правила переходов;
- нужно выявить ошибки статусов до реализации.

## Как строить

1. Определите список состояний сущности.
2. Зафиксируйте события переходов.
3. Добавьте guard conditions для спорных переходов.
4. Проверьте достижимость и терминальные состояния.
5. Протестируйте модель на граничных сценариях.

## Типичные ошибки и как избежать

| Ошибка | Как избежать |
| --- | --- |
| статусы без переходов | проверьте входящие/исходящие связи каждого state |
| неоднозначные события | используйте именование `verb + context` |
| отсутствие guard conditions | фиксируйте условия прямо на переходе |
| невозможность завершить сценарий | добавьте терминальные состояния |

## Инструменты и форматы

- PlantUML, Enterprise Architect, Visual Paradigm;
- экспорт: SVG/PNG/PDF, XMI для репозиториев.
## Стандарты и источники

- [UML](../../glossary.md#abbr-092) 2.5.1 State Machines: <https://www.omg.org/spec/UML/2.5.1>
- PlantUML state docs: <https://plantuml.com/state-diagram>
