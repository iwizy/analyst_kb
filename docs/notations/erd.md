# ERD

ERD (Entity-Relationship Diagram) описывает структуру данных: сущности, атрибуты, связи и ограничения целостности. Это базовый инструмент аналитика для проектирования модели хранения.

## Цель и задачи

- перевести бизнес-объекты в формальную модель данных;
- определить обязательные связи и правила целостности;
- подготовить основу для SQL-схемы, API-контрактов и отчетности.

## Основные элементы

| Элемент | Назначение |
| --- | --- |
| Entity | Сущность предметной области |
| Attribute | Атрибут сущности |
| Primary Key | Уникальный идентификатор |
| Foreign Key | Ссылка на сущность-родитель |
| Relationship | Связь между сущностями |
| Cardinality | Кратность (`1:1`, `1:M`, `M:N`) |

## Когда применять

- проектирование новой БД или большой переработки существующей;
- согласование доменной модели между аналитиками и разработчиками;
- валидация, что требования покрываются структурой данных.

## Пример

```kroki-plantuml
@startuml
hide circle

entity CUSTOMER {
  *customer_id : uuid <<PK>>
  --
  email : text
  created_at : timestamptz
}

entity "ORDER" as ORDER_ENTITY {
  *order_id : uuid <<PK>>
  --
  customer_id : uuid <<FK>>
  status : text
  total_amount : numeric
}

entity ORDER_ITEM {
  *order_item_id : uuid <<PK>>
  --
  order_id : uuid <<FK>>
  product_id : uuid <<FK>>
  quantity : int
  price : numeric
}

entity PRODUCT {
  *product_id : uuid <<PK>>
  --
  sku : text
  name : text
}

CUSTOMER ||--o{ ORDER_ENTITY : places
ORDER_ENTITY ||--|{ ORDER_ITEM : contains
PRODUCT ||--o{ ORDER_ITEM : used in
@enduml
```

## Пошаговый алгоритм построения

1. Соберите список сущностей из требований и глоссария.
1. Для каждой сущности выделите ключ и обязательные атрибуты.
1. Определите связи и кратности.
1. Для `M:N` добавьте связующую сущность.
1. Зафиксируйте ограничения: уникальность, `NOT NULL`, каскады удаления.
1. Проверяйте модель типовыми запросами и отчетами.

## Типовые ошибки

- связь `M:N` без промежуточной сущности;
- отсутствие явных ограничений целостности;
- "универсальные" таблицы с размытым смыслом;
- несогласованные наименования между ERD, API и кодом.

## Визуальные рекомендации

- используйте бизнес-термины, понятные предметной области;
- разделяйте мастер-данные и транзакционные сущности;
- не перегружайте верхнеуровневую ERD техническими полями;
- для больших доменов делайте отдельные подмодели по bounded context.

## Связь с другими нотациями

- `UML Class`: синхронизация доменной модели и структуры данных.
- `C4`: ERD уточняет данные конкретного контейнера/сервиса.
- `DFD`: потоки данных указывают, какие сущности и атрибуты критичны.

## Инструменты

- [PlantUML](../tools/plantuml.md)
- [Draw.io](../tools/drawio.md)
- ERD-редакторы в IDE/DB-инструментах
