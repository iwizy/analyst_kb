# [ERD](../glossary.md#abbr-032)

ERD (Entity Relationship Diagram) описывает структуру данных: сущности, атрибуты, ключи и связи между ними.

## Уровни сложности

### Базовый уровень

- выделять сущности и их атрибуты;
- задавать первичные/внешние ключи;
- определять связи 1:1, 1:N, N:M.

### Средний уровень

- приводить модель к 3NF/BCNF при необходимости;
- управлять M:N через таблицы-связки;
- учитывать read/write-профиль при нормализации.

### Продвинутый уровень

- проектировать денормализацию под аналитические и high-load сценарии;
- связывать ERD с [DDD](../glossary.md#abbr-024) bounded contexts;
- управлять миграциями схемы и эволюцией данных.

## Элементы ERD

| Элемент | Назначение |
| --- | --- |
| Entity | сущность предметной области |
| Attribute | свойство сущности |
| Primary Key | уникальный идентификатор записи |
| Foreign Key | ссылка на связанную сущность |
| Relationship | связь между сущностями |
| Cardinality | кратность (1:1, 1:N, N:M) |

## Пример: нормализованная схема заказов

```kroki-plantuml
@startuml
entity "customers" as C {
  *id : uuid
  --
  name : text
  email : text
}

entity "orders" as O {
  *id : uuid
  --
  customer_id : uuid
  created_at : timestamp
  status : text
}

entity "order_items" as I {
  *id : uuid
  --
  order_id : uuid
  sku : text
  qty : int
  price : numeric
}

C ||--o{ O : customer_id
O ||--|{ I : order_id
@enduml
```

## Пример: денормализованная витрина заказов

```kroki-plantuml
@startuml
entity "order_report" as R {
  *order_id : uuid
  --
  customer_name : text
  customer_segment : text
  order_status : text
  total_amount : numeric
  item_count : int
  payment_status : text
}
@enduml
```

В денормализованной витрине данные клиента и заказа объединены в одну таблицу для быстрого чтения отчетов, но требуют дополнительного контроля актуальности.

## Нормализованная vs денормализованная модель

| Подход | Плюсы | Минусы | Когда выбирать |
| --- | --- | --- | --- |
| Нормализованная | целостность, меньше дублирования | больше join | [OLTP](../glossary.md#abbr-060), транзакционные системы |
| Денормализованная | быстрее чтение, проще отчеты | дубли и сложнее обновления | [OLAP](../glossary.md#abbr-059), витрины, high-read сценарии |

## Плюсы и минусы [ERD](../glossary.md#abbr-032)

| Плюсы | Минусы |
| --- | --- |
| ясно показывает структуру и связи данных | не отражает временной порядок обработки |
| помогает проектировать целостность и ключи | при больших доменах становится громоздкой |
| упрощает согласование аналитика и разработки | требует отдельной модели для потоков данных |

## Когда выбирать ERD

- проектируете структуру БД и data contracts;
- анализируете влияние изменений данных;
- согласовываете терминологию между аналитиком и разработкой.

## Как строить

1. Зафиксируйте бизнес-объекты и их идентификаторы.
2. Добавьте атрибуты и обязательность.
3. Проставьте связи и кратности.
4. Проверьте целостность и отсутствие избыточности.
5. Согласуйте с требованиями и query-профилем.

## Типичные ошибки и как избежать

| Ошибка | Как избежать |
| --- | --- |
| таблицы без PK/FK | все связи фиксируйте ключами |
| неявные M:N связи | используйте таблицы-связки |
| смешение бизнес- и технических полей | разделяйте логический и физический уровни |
| чрезмерная денормализация | применяйте только под измеримый performance case |

## Связь с другими разделами

- [Проектирование модели данных](../database/data-modeling.md)
- [[Нормализация](../glossary.md#term-048)](../database/normalization/normal-forms.md)
- [Типы БД](../database/types/index.md)

## Инструменты и форматы

- draw.io, dbdiagram.io, DataGrip, Enterprise Architect;
- экспорт: SVG/PNG/PDF, [SQL](../glossary.md#abbr-084) DDL, XMI.
## Стандарты и источники

- Chen ER model paper: <https://dl.acm.org/doi/10.1145/320434.320440>
- [ISO](../glossary.md#abbr-043)/IEC 9075 SQL: <https://www.iso.org/standard/76583.html>
- Kimball & Ross [DWH](../glossary.md#abbr-029) Toolkit: <https://www.wiley.com/en-us/The+Data+Warehouse+Toolkit%2C+3rd+Edition-p-9781118530801>
