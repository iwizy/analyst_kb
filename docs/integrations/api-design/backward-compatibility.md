# Обратная совместимость

Обратная совместимость API (Backward Compatibility) — это свойство системы, которое позволяет новым версиям API взаимодействовать с клиентами или компонентами, разработанными для старых версий API. Это критически важно для стабильной работы приложений, использующих API, и для предотвращения нарушений работы пользователей при обновлениях.

## Зачем нужна обратная совместимость?

- Стабильность: Пользователи вашего API могут быть не готовы немедленно адаптироваться к изменениям.
- Минимизация затрат: Обновление клиентского кода для каждого изменения API может быть дорогостоящим.
- Доверие: Предоставление стабильного интерфейса помогает поддерживать доверие пользователей к вашему API.

## Принципы обеспечения обратной совместимости

Добавляйте, но не удаляйте:

Вы можете добавлять новые параметры, методы, или поля, но не удаляйте существующие.

Пример:

```text
// Старая версия API: { "id": 123, "name": "John Doe" } // Новая версия API: { "id": 123, "name": "John Doe", "email": "john@example.com" // Новое поле добавлено, но старые остались. }
```

Избегайте изменения существующих структур и поведения:

Никогда не изменяйте тип данных или значение по умолчанию существующих полей.

Пример:

```text
// Нельзя менять: "id": "123" // Было числом, стало строкой.
```

Поддерживайте прежние точки доступа (endpoints):

- Если вы вводите новые версии, оставляйте старые версии доступными в течение разумного времени.

- /api/v1/users

- /api/v2/users
  Не изменяйте поведение без предупреждения:

- Если метод API возвращал данные в определенном формате или с определенной структурой, оставьте это неизменным.
  Документируйте изменения:

- Ведите подробную историю изменений (changelog) и предоставляйте пользователям информацию о переходе на новую версию.

## Примеры обеспечения обратной совместимости

### Пример 1: Добавление нового поля

Старое поведение:

```text
{ "id": 1, "name": "Alice" }
```

Новое поведение (обратно совместимо):

```text
{ "id": 1, "name": "Alice", "age": 30 }
```

- Клиенты, которые игнорируют новое поле age, продолжат работать.

### Пример 2: Удаление поля (недопустимо без версии)

Старое поведение:

```text
{ "id": 1, "name": "Alice", "age": 30 }
```

Некорректное изменение (не обратно совместимо):

```text
{ "id": 1, "name": "Alice" }
```

- Если клиент полагался на поле age, он выйдет из строя.

### Пример 3: Версионирование API

В случае существенных изменений добавьте новую версию API:

Версия 1:

```text
GET /api/v1/users
```

Ответ:

```text
{ "id": 1, "name": "Alice" }
```

Версия 2:

```text
GET /api/v2/users
```

Ответ:

```text
{ "userId": 1, "fullName": "Alice", "email": "alice@example.com" }
```

Клиенты могут выбрать, когда им обновить код, чтобы начать использовать /api/v2.

## Лучшие практики

Контракты API:

- Используйте схемы (например, JSON Schema или OpenAPI/Swagger), чтобы явно определить структуру данных.
  Механизмы депрекации:

- Уведомляйте клиентов о том, что старые методы или поля будут удалены в будущем.

- Например, добавьте заголовок Deprecation: true или сообщение в ответе API.
  Тестирование:

- Регулярно тестируйте изменения, чтобы убедиться, что старые клиенты продолжают работать.
  Версионирование по мере необходимости:

- Если изменения могут нарушить существующих клиентов, выпускайте новую версию API.
  Документация и коммуникация:

- Убедитесь, что у пользователей есть время и информация для подготовки к изменениям.
  Обеспечение обратной совместимости — это компромисс между развитием и стабильностью, который требует тщательного планирования и ответственности перед пользователями.
