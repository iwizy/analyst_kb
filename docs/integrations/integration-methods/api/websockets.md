# WebSockets

WebSockets — это протокол связи, предоставляющий двустороннюю, полноценно открываемую, постоянную связь между клиентом и сервером. Он часто используется в ситуациях, когда требуется мгновенная передача данных, например, в чатах, игровых приложениях, или для систем с реальным временем, таких как мониторинг или финансовые платформы.

## Основные особенности WebSockets

- Двунаправленная связь: В отличие от HTTP, WebSocket позволяет как клиенту, так и серверу отправлять сообщения в любую сторону в любое время.
- Установление соединения: При первом запросе клиент делает HTTP-запрос для "апгрейда" соединения на WebSocket. После успешного апгрейда, соединение остаётся открытым, и обмен данными может происходить без дополнительных запросов.
- Снижение накладных расходов: После установления соединения между клиентом и сервером, все сообщения передаются с минимальными заголовками, что снижает накладные расходы по сравнению с обычными HTTP-запросами.
- Долгоживущие соединения: WebSocket-соединение может оставаться открытым в течение длительного времени (до тех пор, пока одна из сторон не закроет соединение).

## Структура WebSocket-сообщений

WebSocket-сообщения имеют следующие компоненты:

- Frame — структура данных в WebSocket, которая может быть текстовой или бинарной.

- Payload — полезная нагрузка, которая содержит данные, передаваемые через WebSocket.
  Сообщения могут быть:

- Текстовые: передаются в формате UTF-8.

- Бинарные: могут быть переданы в двух форматах: как данные в формате Blob или ArrayBuffer.

## Установление соединения WebSocket

Пример установления соединения на клиенте:

```text
const socket = new WebSocket('ws://example.com/socket'); socket.onopen = () => { console.log('Соединение открыто'); }; socket.onmessage = (event) => { console.log('Получено сообщение: ' + event.data); }; socket.onclose = () => { console.log('Соединение закрыто'); }; socket.onerror = (error) => { console.log('Ошибка: ' + error.message); };
```

- ws://example.com/socket: адрес WebSocket-сервера.
- onopen: срабатывает при успешном установлении соединения.
- onmessage: срабатывает, когда сервер отправляет сообщение.
- onclose: срабатывает, когда соединение закрывается.
- onerror: срабатывает, когда возникает ошибка.
  Пример на сервере (Node.js с использованием библиотеки ws):

```text
const WebSocket = require('ws'); const wss = new WebSocket.Server({ port: 8080 }); wss.on('connection', (ws) => { console.log('Новое соединение'); ws.on('message', (message) => { console.log('Получено сообщение: ' + message); }); ws.send('Добро пожаловать на сервер!'); });
```

## Пример взаимодействия

## Протокол WebSocket

Протокол WebSocket использует TCP для транспортировки данных, и в отличие от HTTP, который использует запросы и ответы, WebSocket использует одно соединение для двустороннего обмена данными. Стандарт WebSocket работает на порту 80 (ws) и 443 (wss), при этом wss является зашифрованной версией WebSocket, которая использует SSL/TLS.

## Протокол обмена WebSocket (Ручка рукопожатия)

Клиент отправляет запрос на сервер с заголовком Upgrade для переключения на WebSocket.

Пример HTTP-запроса на установку WebSocket-соединения:

```text
GET /socket HTTP/1.1 Host: example.com Upgrade: websocket Connection: Upgrade Sec-WebSocket-Key: x3JJHMbDL1EzLkh9d8 Sec-WebSocket-Version: 13
```

Сервер отвечает с подтверждением апгрейда:

Пример HTTP-ответа:

```text
HTTP/1.1 101 Switching Protocols Upgrade: websocket Connection: Upgrade Sec-WebSocket-Accept: HSmxxnC4T35F5s5zZf==
```

После этого установлено соединение WebSocket, и обмен данными может быть выполнен через frames.

## Закрытие соединения

Когда одно из соединений решает закрыть соединение, оно отправляет специальный фрейм с кодом завершения, а другое соединение подтверждает закрытие.

Пример фрейма закрытия:

- Код 1000: нормальное завершение.
- Код 1001: сервер завершил соединение.
- Код 1002: ошибка протокола.
  Пример на клиенте для закрытия соединения:

```text
socket.close(1000, 'Завершаю соединение');
```

Пример на сервере для закрытия соединения:

```text
ws.close(1000, 'Завершаю соединение');
```

## Преимущества и недостатки WebSockets

Преимущества:

- Долгосрочные соединения — подходит для приложений, требующих постоянной связи.

- Низкие задержки — обмен данными происходит мгновенно, без необходимости повторных запросов.

- Минимальные накладные расходы — после установления соединения обмен сообщениями осуществляется с минимальными заголовками.
  Недостатки:

- Нет гарантии доставки — WebSocket не обеспечивает надежную доставку сообщений.

- Не подходит для всех типов приложений — WebSockets лучше подходят для приложений в реальном времени, а не для традиционных веб-сайтов.

- Загрузка серверов — так как соединение поддерживается постоянно, серверы должны обрабатывать множество открытых соединений.

## Когда использовать WebSockets?

- В чатах и мессенджерах.
- Для приложений в реальном времени, например, финансовых платформ.
- В онлайн-играх для обмена сообщениями между клиентами.
- Для передачи данных в системах мониторинга в реальном времени.
  Этот протокол предоставляет множество преимуществ в сценариях с высоким объёмом взаимодействий в реальном времени.
