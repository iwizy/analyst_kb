# Обмен файлами

Файловый обмен остается важным для B2B и регламентных интеграций, где процесс строится пакетами по расписанию.

## Уровни сложности

### Базовый уровень

- выбирать протокол передачи (SFTP/FTPS/AS2/S3);
- фиксировать формат файла и схему;
- обеспечивать подтверждение получения.

### Средний уровень

- внедрять шифрование и подпись (PGP, TLS, SSH);
- проектировать retry, архивирование, дедупликацию;
- контролировать SLA на доставку и обработку.

### Продвинутый уровень

- автоматизировать pipeline передачи через ETL/orchestration;
- строить end-to-end monitoring и lineage;
- управлять версионированием форматов и миграцией партнеров.

## Протоколы и платформы

| Подход | Плюсы | Ограничения | Когда использовать |
| --- | --- | --- | --- |
| SFTP | простота, распространенность | ручные операции без автоматизации | классический B2B |
| FTPS | TLS-защита поверх FTP | сложнее firewall/NAT | legacy контур |
| AS2 | EDI, подпись и MDN ack | сложная настройка | строгий B2B compliance |
| S3-based transfer | масштаб и автоматизация | требует cloud governance | data exchange в cloud |
| MFT платформы | централизованный контроль и audit | стоимость | крупные enterprise интеграции |

## Форматы файлов

| Формат | Сценарий | Риски |
| --- | --- | --- |
| CSV | простые табличные выгрузки | типизация и экранирование |
| JSON | вложенные структуры | объем и схемы |
| XML | строгие контракты | большой размер |
| XLSX | бизнес-обмен вручную | слабая автоматизация |
| Avro/Parquet | аналитические пайплайны | выше порог tooling |

## Типовой процесс обмена

```kroki-plantuml
@startuml
start
:Сформировать файл по контракту;
:Подписать и зашифровать;
:Передать по каналу;
:Проверить checksum и схему;
if (валидно?) then (yes)
  :Импорт и бизнес-обработка;
  :Отправить ACK;
else (no)
  :NACK и retry policy;
endif
:Архивировать файл и лог;
stop
@enduml
```

## Что фиксировать в контракте

- расписание отправки и SLA окна;
- формат, кодировка, delimiter, locale;
- схема полей и правила валидации;
- правила подписи/шифрования;
- ACK/NACK протокол, retry и дедлайн обработки.

## Автоматизация

- orchestration: Airflow, NiFi, Talend;
- контроль целостности: checksum/signature;
- мониторинг: missing files, late files, corrupted records;
- хранение: hot/cold архив и retention policy.

## Типичные ошибки

- отсутствие версионирования схем файлов;
- ручной процесс без traceability;
- нет обработки частично валидных файлов;
- отсутствие SLA и эскалации по пропуску окна.

## Контрольные вопросы

1. Как подтверждается доставка и корректность файла?
2. Где и как хранятся архивы и контрольные суммы?
3. Что происходит при частичной валидации пакета?
4. Какие RTO/RPO требования к файловому обмену?

## Чек-лист самопроверки

- протокол и security-параметры согласованы;
- формат и версия схемы формализованы;
- ACK/NACK, retry и дедупликация настроены;
- мониторинг пропусков и порчи данных включен;
- есть runbook на инциденты и ручной reprocess.

## Стандарты и источники

- RFC 959 FTP: <https://www.rfc-editor.org/rfc/rfc959>
- RFC 4253 SSH Transport (SFTP foundation): <https://www.rfc-editor.org/rfc/rfc4253>
- AS2 RFC 4130: <https://www.rfc-editor.org/rfc/rfc4130>
- OpenPGP RFC 9580: <https://www.rfc-editor.org/rfc/rfc9580>
