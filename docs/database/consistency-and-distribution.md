# Консистентность и распределение

Эта тема определяет фундаментальные компромиссы при выборе архитектуры данных в распределенной системе.

## ACID vs BASE

### ACID

Подходит для сценариев, где критичны корректность и предсказуемость транзакций.

- Atomicity: транзакция выполняется целиком или откатывается.
- Consistency: данные переходят между валидными состояниями.
- Isolation: параллельные транзакции не ломают друг друга.
- Durability: подтвержденные изменения сохраняются после сбоев.

Типичные системы:

- PostgreSQL, Oracle, SQL Server, MySQL InnoDB, CockroachDB.

### BASE

Подходит для высокораспределенных систем, где приоритетны доступность и масштаб.

- Basically Available: система старается отвечать всегда.
- Soft state: состояние может быть временно несогласованным.
- Eventual consistency: копии данных сходятся со временем.

Типичные системы:

- Cassandra, DynamoDB, Riak, Couchbase.

## CAP-теорема

В условиях сетевого разделения (Partition tolerance) невозможно одновременно гарантировать и строгую консистентность (Consistency), и полную доступность (Availability).

```kroki-plantuml
@startuml
skinparam linetype ortho
circle "Consistency" as C
circle "Availability" as A
circle "Partition tolerance" as P
C - A
A - P
P - C
note right of P
В распределенных системах
P обычно обязательна.
Выбор идет между C и A.
end note
@enduml
```

## Eventual Consistency

Смысл: после завершения репликации все узлы придут к одному состоянию, но не мгновенно.

Когда это допустимо:

- счетчики просмотров;
- каталоги и ленты;
- аналитические витрины;
- кэшированные профили.

Когда это рискованно:

- платежи;
- инвентарь с жестким остатком;
- антифрод в реальном времени;
- финансовая отчетность в моменте.

## Практический пример

Сценарий интернет-магазина:

- оплата заказа: ACID, чтобы не допустить двойного списания;
- рекомендации и популярные товары: BASE/eventual consistency;
- поиск по каталогу: реплицируемый индекс с eventual consistency.

## Чек-лист архитектора

- что важнее для данного потока: доступность или строгая консистентность;
- какую максимальную задержку консистентности можно допустить;
- где должны быть транзакционные границы;
- как будет выполняться reconciliation при рассинхронизации;
- какие метрики контролируют consistency lag.

## Смежные материалы

- [Типы баз данных](types/index.md)
- [Реплицирование данных](replication.md)
- [Масштабирование БД](scaling/index.md)
