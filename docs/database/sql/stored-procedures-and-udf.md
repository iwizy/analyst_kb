# Хранимые процедуры и пользовательские функции

Процедуры и UDF позволяют вынести повторяемую бизнес-логику на уровень БД, но требуют дисциплины версионирования и контроля производительности.

## Хранимые процедуры

Процедура это именованный блок SQL/PL кода, который может:

- принимать параметры;
- выполнять DML/DDL;
- управлять транзакциями (зависит от СУБД);
- возвращать результаты.

### Пример процедуры (PostgreSQL style)

```sql
CREATE OR REPLACE PROCEDURE apply_discount(p_customer_id bigint, p_pct numeric)
LANGUAGE plpgsql
AS $$
BEGIN
  UPDATE orders
  SET amount = amount * (1 - p_pct)
  WHERE customer_id = p_customer_id
    AND status = 'draft';
END;
$$;

CALL apply_discount(932, 0.10);
```

## Пользовательские функции (UDF)

UDF возвращает значение (скаляр) или набор строк (табличная функция).

### Пример скалярной функции

```sql
CREATE OR REPLACE FUNCTION full_name(p_first text, p_last text)
RETURNS text
LANGUAGE sql
AS $$
  SELECT trim(p_first || ' ' || p_last);
$$;

SELECT full_name('Ирина', 'Котова');
```

## Процедура vs функция

| Критерий | Процедура | UDF |
| --- | --- | --- |
| Возврат значения | опционально | обязательно |
| Основной сценарий | бизнес-операции и batch | вычисления и переиспользуемая логика |
| Использование в SELECT | обычно нет | да |

## Когда использовать

- много одинаковой SQL-логики в разных сервисах;
- нужны атомарные batch-операции внутри БД;
- требуется минимизировать сетевые round-trip.

## Риски

- усложнение CI/CD и миграций схемы;
- vendor lock-in на PL-язык конкретной СУБД;
- "скрытая" бизнес-логика вне приложения.

## Практические рекомендации

- версионировать процедуры/функции как миграции;
- писать unit/integration tests для db-логики;
- документировать side effects и транзакционные границы;
- не переносить всю доменную логику в БД без необходимости.

## Смежные материалы

- [Селекты](selects.md)
- [Вложенные запросы](subqueries.md)
