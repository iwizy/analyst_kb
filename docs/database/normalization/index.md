# Нормализация и денормализация

Нормализация снижает избыточность и аномалии данных в OLTP, денормализация ускоряет чтение и аналитику в OLAP/read-heavy сценариях.

## Уровни сложности

### Базовый

- понимать зачем нужны 1NF, 2NF, 3NF;
- видеть аномалии вставки/обновления/удаления.

### Средний

- выбирать степень нормализации под workload;
- использовать материализованные представления для ускорения отчетов.

### Продвинутый

- проектировать гибрид OLTP/OLAP модели;
- управлять стоимостью хранения и производительностью через денормализацию.

## Когда нормализовать, когда денормализовать

| Критерий | Нормализация | Денормализация |
| --- | --- | --- |
| Транзакционная корректность | приоритет | ниже |
| Частота обновлений | высокая | умеренная/низкая |
| Сложность отчетов | может требовать join | ускоряется за счет предагрегации |
| Стоимость хранения | ниже | выше |
| Latency чтения | зависит от join | обычно ниже для заранее собранных витрин |

## Матрица выбора

| Условие | Решение |
| --- | --- |
| OLTP, строгие инварианты, частые update | 3NF/BCNF |
| BI/аналитика, стабильные чтения | денормализованная витрина / star schema |
| Смешанный режим | core в 3NF + materialized views/read models |

## Материализованные представления

Пример:

```sql
CREATE MATERIALIZED VIEW mv_sales_daily AS
SELECT date(created_at) AS day,
       product_id,
       SUM(amount) AS revenue
FROM sales
GROUP BY day, product_id;
```

Практика:

- обновлять по расписанию/инкрементально;
- документировать допустимую "свежесть" данных.

## Типовые ошибки

- денормализовать до понимания реальных bottleneck;
- использовать денормализованную витрину как transactional source of truth;
- отсутствие контроля консистентности между source и витриной.

## Практические рекомендации

1. Начинайте с нормализованной модели для транзакционного ядра.
2. Денормализуйте только под измеримые read bottleneck.
3. Для витрин вводите SLA свежести и quality checks.
4. Регулярно переоценивайте модель при изменении нагрузки.

## Контрольные вопросы

1. Какие аномалии устраняет ваша текущая модель?
2. Где join-нагрузка действительно мешает SLA?
3. Какие витрины можно поддерживать инкрементально?
4. Как контролируется согласованность денормализованных данных?

## Чек-лист самопроверки

- выбран обоснованный уровень нормализации;
- определены read-heavy кандидаты на денормализацию;
- материализованные представления имеют refresh policy;
- есть контроль качества и reconcile-процедуры;
- документированы trade-off по storage/performance.

## Стандарты и источники

- Codd normal forms overview: <https://en.wikipedia.org/wiki/Database_normalization>
- PostgreSQL materialized views: <https://www.postgresql.org/docs/current/rules-materializedviews.html>
- Kimball & Ross: <https://www.wiley.com/en-us/The+Data+Warehouse+Toolkit%2C+3rd+Edition-p-9781118530801>
