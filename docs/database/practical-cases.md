# Практические примеры выбора и проектирования БД
Страница показывает, как применять материалы раздела «Базы данных» на реальных сценариях с разными требованиями к консистентности, производительности и стоимости владения.

## Уровни сложности

### Базовый уровень

- сопоставлять доменный сценарий с типом [БД](../glossary.md#abbr-007);
- оценивать ключевые нефункциональные параметры: [SLA](../glossary.md#abbr-079), задержка, объем данных;
- фиксировать базовые критерии выбора в таблице решений.

### Средний уровень

- проектировать polyglot-подход (primary + специализированные хранилища);
- учитывать компромиссы [CAP](../glossary.md#abbr-013)/[PACELC](../glossary.md#abbr-061);
- связывать выбор БД с эксплуатационными требованиями: backup, репликация, [RTO](../glossary.md#abbr-076), [RPO](../glossary.md#abbr-074).

### Продвинутый уровень

- проектировать multi-region конфигурации;
- формировать стратегию миграции и эволюции модели данных;
- оценивать влияние архитектурного выбора на риски и бюджет.

## Единый шаблон анализа сценария

| Блок | Что фиксировать | Пример |
| --- | --- | --- |
| Бизнес-цель | зачем нужна система и какой результат ожидается | уменьшить время обработки платежа до 2 секунд |
| Тип нагрузки | read/write ratio, пиковые значения, профиль запросов | 30% read, 70% write, пиковая запись в часы распродажи |
| Критичность консистентности | где обязательна strong consistency, где допустима eventual | платежи: strong; витрина каталога: eventual |
| Ограничения | регуляторика, хранение ПДн, аудит, бюджет | обязательный аудит и хранение истории операций 5 лет |
| Целевые метрики | p95 latency, availability, стоимость | p95 <= 150 ms, availability 99.95% |

## Кейс 1. Fintech: платежи и бухгалтерский контур

### Исходные условия

- высокая критичность транзакций;
- строгая аудируемость операций;
- запрет потери или дублирования финансовых событий.

### Архитектурное решение

- primary store: PostgreSQL;
- поток событий: Kafka;
- аналитический контур: ClickHouse;
- [CDC](../glossary.md#abbr-014) в [DWH](../glossary.md#abbr-029) для отчетности.

```kroki-plantuml
@startuml
left to right direction
actor Client
rectangle "Payment API" as API
database "PostgreSQL\n(OLTP)" as PG
queue "Kafka" as K
database "ClickHouse\n(Analytics)" as CH

Client --> API : create payment
API --> PG : transaction commit
PG --> K : CDC events
K --> CH : stream load
@enduml
```

### Почему так

| Критерий | Решение | Обоснование |
| --- | --- | --- |
| Транзакционная целостность | PostgreSQL | ACID-инварианты для денег и балансов |
| Масштабируемая доставка событий | Kafka | разделение операционного и аналитического контуров |
| Быстрые аналитические отчеты | ClickHouse | heavy read без деградации OLTP |

### Типичные ошибки

- попытка строить финальную отчетность напрямую на OLTP;
- отсутствие сценария восстановления после частичного отказа;
- несогласованность схем между транзакционным и аналитическим слоями.

## Кейс 2. E-commerce: каталог, корзина и заказы

### Исходные условия

- гибкая структура атрибутов каталога;
- всплески чтения во время маркетинговых кампаний;
- строгая консистентность заказа и резерва товара.

### Архитектурное решение

- заказы и платежи: PostgreSQL;
- каталог: MongoDB;
- поиск: OpenSearch;
- кэш карточек и корзины: Redis.

### Пример разбиения по сценариям

| Сценарий | Ключевое требование | Хранилище |
| --- | --- | --- |
| Создание заказа | атомарная запись заказа и резерва | PostgreSQL |
| Поиск товара по фильтрам | гибкие атрибуты + полнотекст | MongoDB + OpenSearch |
| Быстрый показ карточки | низкая задержка повторных запросов | Redis |

### Практический trade-off

- большее количество хранилищ увеличивает операционную сложность;
- но снижает риск деградации общей системы под смешанной нагрузкой.

## Кейс 3. Gov: межведомственный обмен и аудит

### Исходные условия

- жесткая регуляторика;
- обязательный след изменений;
- интеграции с внешними ведомствами через пакетные и API-каналы.

### Архитектурное решение

- master-регистры: реляционная БД;
- неизменяемый журнал действий: permissioned ledger;
- архивные и отчетные витрины: DWH.

### Особенности

| Область | Практика |
| --- | --- |
| Управление данными | централизованные справочники и MDM-процессы |
| Аудит | двойной контроль: журнал в БД + внешний журнал событий |
| Эксплуатация | регулярные drill-проверки восстановления |

## Кейс 4. IoT: телеметрия и управление устройствами

### Исходные условия

- непрерывный high-volume поток телеметрии;
- запросы по временным интервалам;
- отдельные требования к мастер-данным устройств.

### Архитектурное решение

- time-series БД для телеметрии;
- реляционная БД для устройств, пользователей и прав;
- стриминговая обработка для аномалий и алертов.

### Мини-матрица выбора

| Требование | Time-series DB | Реляционная DB |
| --- | --- | --- |
| запись по времени | сильная сторона | ограниченно |
| join по справочникам | ограниченно | сильная сторона |
| хранение агрегатов | эффективно с retention policy | возможно, но дороже по ресурсам |

## Шаблон сравнения двух СУБД под проект

| Критерий | Вес | Вариант A | Вариант B | Комментарий |
| --- | --- | --- | --- | --- |
| Консистентность | 5 |  |  |  |
| Производительность записи | 4 |  |  |  |
| Производительность чтения | 4 |  |  |  |
| Гибкость схемы | 3 |  |  |  |
| Сложность эксплуатации | 3 |  |  |  |
| Стоимость владения | 3 |  |  |  |
| Интеграция с текущим стеком | 2 |  |  |  |

## Связанные материалы

- [Введение в раздел «Базы данных»](index.md)
- [Типы баз данных](types/index.md)
- [Консистентность и распределение](consistency-and-distribution.md)
- [Проектирование модели данных](data-modeling.md)
- [Масштабирование БД](scaling/index.md)
- [Реплицирование данных](replication.md)
- [Бэкапирование данных](backup.md)

## Стандарты и источники

- ISO/IEC 9075 SQL: <https://www.iso.org/standard/76583.html>
- CAP theorem paper (Gilbert, Lynch): <https://dl.acm.org/doi/10.1145/564585.564601>
- PACELC (Abadi): <https://ieeexplore.ieee.org/document/6133253>
- Google Spanner paper: <https://research.google/pubs/pub39966/>
- Kimball & Ross, The Data Warehouse Toolkit: <https://www.wiley.com/en-us/The+Data+Warehouse+Toolkit%2C+3rd+Edition-p-9781118530801>
