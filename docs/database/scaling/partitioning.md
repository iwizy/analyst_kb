# Партиционирование

Партиционирование делит крупную таблицу на управляемые части, чтобы ускорить выборки, упростить архивирование и снизить эксплуатационные риски.

## Уровни сложности

### Базовый

- range/list/hash partition;
- partition pruning.

### Средний

- lifecycle policy: create, detach, archive, drop;
- локальные индексы и статистика по разделам.

### Продвинутый

- online repartitioning и zero-downtime миграции;
- комбинированное партиционирование для multi-tenant.

## Типы партиционирования

| Тип | Когда применять |
| --- | --- |
| Range | данные по времени (orders/events/logs) |
| List | ограниченный набор значений (регион/тенант) |
| Hash | равномерное распределение ключей |

## Пример (range by month)

```sql
CREATE TABLE orders (
  order_id BIGINT,
  created_at DATE,
  total_amount NUMERIC(14,2)
) PARTITION BY RANGE (created_at);
```

## Практика эксплуатации

- создавать разделы заранее (rolling window);
- контролировать размер и skew;
- архивировать старые разделы в cold storage;
- держать runbook на attach/detach.

## Типовые ошибки

- неверный ключ партиции, не соответствующий фильтрам;
- слишком много мелких разделов;
- отсутствие автоматизации жизненного цикла партиций.

## Практические рекомендации

1. Выбирайте ключ партиции по доминирующим фильтрам.
2. Держите target размер раздела, например 5-50 GB для OLTP событийных таблиц.
3. Проверяйте pruning через `EXPLAIN`.
4. Автоматизируйте housekeeping и архивирование.

## Контрольные вопросы

1. Какие запросы выигрывают от partition pruning?
2. Какой целевой размер и количество разделов в горизонте года?
3. Как выполняется архивирование и восстановление старых разделов?

## Чек-лист самопроверки

- ключ партиции обоснован query patterns;
- жизненный цикл разделов автоматизирован;
- контроль skew и размера разделов настроен;
- операции attach/detach задокументированы.

## Стандарты и источники

- PostgreSQL partitioning: <https://www.postgresql.org/docs/current/ddl-partitioning.html>
- MySQL partitioning: <https://dev.mysql.com/doc/refman/en/partitioning.html>
