# Шардирование

Шардирование делит данные горизонтально между несколькими узлами (shards), чтобы масштабировать хранилище и throughput по мере роста системы.

## Когда применять

- объем данных и write-нагрузка превысили предел одного кластера;
- vertical scaling перестал быть экономически оправдан;
- нужны geo-distribution и локальность данных.

## Стратегии шардирования

- Hash-based: равномерное распределение по хэшу ключа;
- Range-based: диапазоны значений;
- Geo-based: по региону/локальности;
- Directory-based: маршрутизация через lookup-таблицу.

## Пример маршрутизации

```text
shard = hash(customer_id) % N
```

## Диаграмма

```kroki-plantuml
@startuml
node Router
database Shard1
database Shard2
database Shard3

Router --> Shard1 : key mod 3 = 0
Router --> Shard2 : key mod 3 = 1
Router --> Shard3 : key mod 3 = 2
@enduml
```

## Достоинства

- линейный рост емкости и пропускной способности;
- снижение нагрузки на каждый узел;
- возможность изолировать сбои на уровне шарда.

## Недостатки

- сложная маршрутизация и rebalance;
- cross-shard join и транзакции становятся дорогими;
- риск hot shard при плохом ключе;
- выше операционная сложность.

## Типовые ошибки

- выбор монотонного shard key (например, auto-increment id без salt);
- отсутствие стратегии миграции при изменении числа шардов;
- игнорирование cross-shard запросов в аналитике и отчётах.

## Практические рекомендации

- проектировать shard key от распределения нагрузки, а не только от удобства;
- добавлять observability: per-shard QPS, p95, storage, lag;
- закладывать процессы rebalancing и backfill;
- выносить глобальную аналитику в DWH/Data Lake.

## Смежные материалы

- [Партицирование](partitioning.md)
- [DWH и Data Lake](../dwh-and-data-lake.md)
- [Консистентность и распределение](../consistency-and-distribution.md)
